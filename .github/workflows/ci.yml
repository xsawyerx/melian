name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            configure_flags: "--with-sqlite3=/usr"
          - os: macos-latest
            configure_flags: "--with-sqlite3=$(brew --prefix sqlite) --with-libevent=$(brew --prefix libevent) --with-jansson=$(brew --prefix jansson)"
    runs-on: ${{ matrix.os }}
    env:
      MELIAN_TABLE_TABLES: 'table1#0|60|id#0:int,table2#1|60|id#0:int;hostname#1:string'
      MELIAN_DB_DRIVER: sqlite
      MELIAN_SQLITE_FILENAME: ${{ github.workspace }}/melian_sqlite.db
      MELIAN_SOCKET_PATH: /tmp/melian.sock
      MELIAN_LIVE_TEST: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: clients/nodejs/package-lock.json

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            build-essential \
            cpanminus \
            composer \
            libevent-dev \
            libjansson-dev \
            libsqlite3-dev \
            perl \
            php-cli \
            php-mbstring \
            php-xml \
            python3 \
            python3-pip \
            pkg-config \
            sqlite3 \
            texinfo \
            xz-utils

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install \
            autoconf \
            automake \
            cpanminus \
            composer \
            libevent \
            jansson \
            sqlite \
            perl \
            php \
            python \
            pkg-config \
            node \
            xz
          echo "PKG_CONFIG_PATH=$(brew --prefix libevent)/lib/pkgconfig:$(brew --prefix jansson)/lib/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV

      - name: Install Automake 1.17
        run: |
          curl -sSL https://ftp.gnu.org/gnu/automake/automake-1.17.tar.xz -o /tmp/automake.tar.xz
          tar -xf /tmp/automake.tar.xz -C /tmp
          pushd /tmp/automake-1.17 >/dev/null
          ./configure --prefix=/usr/local
          JOBS=$(getconf _NPROCESSORS_ONLN 2>/dev/null || sysctl -n hw.ncpu || echo 2)
          make -j"${JOBS}"
          if command -v sudo >/dev/null 2>&1; then
            sudo make install
          else
            make install
          fi
          popd >/dev/null
          rm -rf /tmp/automake-1.17 /tmp/automake.tar.xz

      - name: Configure (SQLite only)
        run: |
          if [ -n "${{ matrix.configure_flags }}" ]; then
            ./configure ${{ matrix.configure_flags }} \
              CPPFLAGS="-I$(brew --prefix libevent)/include -I$(brew --prefix jansson)/include" \
              LDFLAGS="-L$(brew --prefix libevent)/lib -L$(brew --prefix jansson)/lib"
          else
            ./configure \
              CPPFLAGS="-I$(brew --prefix libevent)/include -I$(brew --prefix jansson)/include" \
              LDFLAGS="-L$(brew --prefix libevent)/lib -L$(brew --prefix jansson)/lib"
          fi

      - name: Build
        run: |
          JOBS=$(getconf _NPROCESSORS_ONLN 2>/dev/null || sysctl -n hw.ncpu || echo 2)
          make -j"${JOBS}"

      - name: setup cpanm with local::lib
        run: cpanm --local-lib=~/perl5 local::lib

      - name: Install Perl dependencies
        working-directory: clients/perl
        run: cpanm -l ~/perl5 --quiet --notest --installdeps .

      - name: Install Python dependencies
        working-directory: clients/python
        run: |
          python3 -m pip install --break-system-packages --upgrade pip
          python3 -m pip install --break-system-packages -r requirements.txt

      - name: Install Node.js dependencies
        working-directory: clients/nodejs
        run: npm ci

      - name: Install PHP dependencies
        working-directory: clients/php
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Prepare SQLite database
        run: |
          rm -f "$MELIAN_SQLITE_FILENAME"
          gunzip -c .github/workflows/assets/melian-sqlite.sql.gz | sqlite3 "$MELIAN_SQLITE_FILENAME"

      - name: Client tests and benchmarks
        run: |
          set -euo pipefail
          ./melian-server >server.log 2>&1 &
          server_pid=$!
          trap 'kill "$server_pid" 2>/dev/null || true' EXIT
          trap 'cat server.log; kill "$server_pid" 2>/dev/null || true' ERR
          wait_seconds=0
          while [ ! -S /tmp/melian.sock ]; do
            if [ "$wait_seconds" -ge 30 ]; then
              echo "Server socket not ready after 30 seconds"
              exit 1
            fi
            sleep 1
            wait_seconds=$((wait_seconds + 1))
          done
          rc=0
          run_client_suite() {
            local label=$1
            shift
            echo "::group::${label} client tests"
            if "$@"; then
              echo "[${label}] tests passed"
            else
              echo "[${label}] tests failed"
              rc=1
            fi
            echo "::endgroup::"
          }
          run_client_suite "Perl" bash -c 'set -e; cd clients/perl; eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib); prove -lr t/'
          run_client_suite "Python" bash -c 'set -e; cd clients/python; python3 -m pytest -q'
          run_client_suite "PHP" bash -c 'set -e; cd clients/php; ./vendor/bin/phpunit'
          run_client_suite "Node.js" bash -c 'set -e; cd clients/nodejs; npm test'
          echo "::group::Benchmarks"
          echo "===== BENCHMARKS ====="
          echo "--- query table 1 ---"
          melian_output_u=$(./melian-client -U)
          echo "$melian_output_u"
          if ! grep -q "1000 good" <<<"$melian_output_u"; then
            echo "[bench -U] expected '1000 good' in output"
            rc=1
          fi
          echo "--- query table 2 (integer) ---"
          melian_output_c=$(./melian-client -C)
          echo "$melian_output_c"
          if ! grep -q "10000 good" <<<"$melian_output_c"; then
            echo "[bench -C] expected '10000 good' in output"
            rc=1
          fi
          echo "--- query table 2 (string) ---"
          melian_output_h=$(./melian-client -H)
          echo "$melian_output_h"
          if ! grep -q "10000 good" <<<"$melian_output_h"; then
            echo "[bench -H] expected '10000 good' in output"
            rc=1
          fi
          echo "::endgroup::"
          exit $rc

  build-and-test-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    env:
      MELIAN_TABLE_TABLES: 'table1#0|60|id#0:int,table2#1|60|id#0:int;hostname#1:string'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            git
            autoconf
            automake
            libtool
            gettext
            pkgconf
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-libevent
            mingw-w64-x86_64-jansson
            mingw-w64-x86_64-sqlite3

      - name: Configure (SQLite only)
        run: ./configure --with-sqlite3=/mingw64 --with-libevent=/mingw64 --with-jansson=/mingw64

      - name: Build
        run: |
          JOBS=$(nproc)
          make -j"${JOBS}"

  build-and-test-freebsd:
    runs-on: macos-latest
    env:
      MELIAN_TABLE_TABLES: 'table1#0|60|id#0:int,table2#1|60|id#0:int;hostname#1:string'
      MELIAN_DB_DRIVER: sqlite
      MELIAN_SQLITE_FILENAME: /github/workspace/melian_sqlite.db
      MELIAN_SOCKET_PATH: /tmp/melian.sock
      MELIAN_LIVE_TEST: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: FreeBSD build
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          copyback: false
          envs: MELIAN_TABLE_TABLES MELIAN_DB_DRIVER MELIAN_SQLITE_FILENAME MELIAN_SOCKET_PATH MELIAN_LIVE_TEST
          run: |
            set -euo pipefail
            pkg update -f
            pkg install -y autoconf automake gmake pkgconf libevent jansson sqlite3 perl5 p5-App-cpanminus python3 py39-pip php composer node npm git
            cd /github/workspace
            export PATH="/usr/local/bin:/usr/local/sbin:$PATH"
            ./configure --with-sqlite3=/usr/local --with-libevent=/usr/local --with-jansson=/usr/local
            gmake -j"$(sysctl -n hw.ncpu)"
            cpanm --local-lib=~/perl5 local::lib
            (cd clients/perl && cpanm -l ~/perl5 --quiet --notest --installdeps .)
            (cd clients/python && python3 -m pip install --upgrade pip && python3 -m pip install -r requirements.txt)
            (cd clients/js && npm install)
            (cd clients/php/Melian && composer install --no-interaction --no-progress --prefer-dist)
            rm -f "$MELIAN_SQLITE_FILENAME"
            gunzip -c .github/workflows/assets/melian-sqlite.sql.gz | sqlite3 "$MELIAN_SQLITE_FILENAME"
            ./melian-server >server.log 2>&1 &
            server_pid=$!
            trap 'kill "$server_pid" 2>/dev/null || true' EXIT
            for i in $(seq 1 30); do
              if [ -S /tmp/melian.sock ]; then break; fi
              sleep 1
            done
            if [ ! -S /tmp/melian.sock ]; then
              echo "Server socket not ready after 30 seconds"
              exit 1
            fi
            run_client_suite() {
              local label=$1
              shift
              echo "::group::${label} client tests"
              if "$@"; then
                echo "[${label}] tests passed"
              else
                echo "[${label}] tests failed"
              fi
              echo "::endgroup::"
            }
            run_client_suite "Perl" sh -c 'cd clients/perl && eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib) && prove -lr t/'
            run_client_suite "Python" sh -c 'cd clients/python && python3 -m pytest -q'
            run_client_suite "PHP" sh -c 'cd clients/php/Melian && ./vendor/bin/phpunit'
            run_client_suite "Node.js" sh -c 'cd clients/js && npm test'
