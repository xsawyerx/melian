name: CI

on:
  push:
  pull_request:

jobs:
  sqlite-perl:
    runs-on: ubuntu-latest
    env:
      MELIAN_TABLE_TABLES: 'table1#0|60|id#0:int,table2#1|60|id#0:int;hostname#1:string'
      MELIAN_DB_DRIVER: sqlite
      MELIAN_SQLITE_FILENAME: ${{ github.workspace }}/melian_sqlite.db
      MELIAN_SOCKET_PATH: /tmp/melian.sock
      MELIAN_LIVE_TEST: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: clients/js/package-lock.json

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            build-essential \
            cpanminus \
            composer \
            libevent-dev \
            libjansson-dev \
            libsqlite3-dev \
            perl \
            php-cli \
            php-mbstring \
            php-xml \
            python3 \
            python3-pip \
            pkg-config \
            sqlite3 \
            texinfo \
            xz-utils

      - name: Install Automake 1.17
        run: |
          curl -sSL https://ftp.gnu.org/gnu/automake/automake-1.17.tar.xz -o /tmp/automake.tar.xz
          tar -xf /tmp/automake.tar.xz -C /tmp
          pushd /tmp/automake-1.17 >/dev/null
          ./configure --prefix=/usr/local
          make -j"$(nproc)"
          sudo make install
          popd >/dev/null
          rm -rf /tmp/automake-1.17 /tmp/automake.tar.xz

      - name: Configure (SQLite only)
        run: ./configure --with-sqlite3=/usr

      - name: Build
        run: make -j"$(nproc)"

      - name: setup cpanm with local::lib
        run: cpanm --local-lib=~/perl5 local::lib

      - name: Install Perl dependencies
        working-directory: clients/perl
        run: cpanm -l ~/perl5 --quiet --notest --installdeps .

      - name: Install Python dependencies
        working-directory: clients/python
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

      - name: Install Node.js dependencies
        working-directory: clients/js
        run: npm ci

      - name: Install PHP dependencies
        working-directory: clients/php/Melian
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Prepare SQLite database
        run: |
          rm -f "$MELIAN_SQLITE_FILENAME"
          gunzip -c .github/workflows/assets/melian-sqlite.sql.gz | sqlite3 "$MELIAN_SQLITE_FILENAME"

      - name: Run client tests (Perl, Python, PHP, Node.js)
        run: |
          set -euo pipefail
          ./melian-server >server.log 2>&1 &
          server_pid=$!
          trap 'kill "$server_pid" 2>/dev/null || true' EXIT
          trap 'cat server.log; kill "$server_pid" 2>/dev/null || true' ERR
          timeout 30 bash -c 'until [ -S /tmp/melian.sock ]; do sleep 1; done'
          pushd clients/perl >/dev/null
          echo -e "\nPerl:"; eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib) && prove -lr t/
          popd >/dev/null
          pushd clients/python >/dev/null
          echo -e "\nPython:"; python3 -m pytest -q
          popd >/dev/null
          pushd clients/php/Melian >/dev/null
          echo -e "\nPHP:"; ./vendor/bin/phpunit
          popd >/dev/null
          pushd clients/js >/dev/null
          echo -e "\nNode.js:"; npm test
          popd >/dev/null
